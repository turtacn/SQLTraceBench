#!/bin/bash

# A script to generate fake output for creating a demo GIF.
# Use a tool like 'asciinema rec' or 'termtosvg' to record this.

# ANSI color codes
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo_step() {
    echo -e "${GREEN}✔${NC} $1"
    sleep 0.5
}

echo_info() {
    echo -e "${CYAN}i${NC} $1"
    sleep 0.2
}

echo_warn() {
    echo -e "${YELLOW}⚠${NC} $1"
    sleep 0.2
}

# --- Start of Demo ---

# Clear screen
clear

# Fake command
echo -e "$ sql_trace_bench run --config ./config.yaml"
sleep 1

# Phase 1: Parsing
echo_step "Configuration loaded from ./config.yaml"
echo_info "Source DB: StarRocks, Target DB: ClickHouse"
echo_step "Parsing source schema: ./schemas/starrocks_schema.yml"
echo_info "Found 5 tables and 42 columns."
echo_step "Parsing source trace: ./traces/starrocks_trace.jsonl"
echo_info "Read 1,250,831 query events."

# Phase 2: Transformation
echo_step "Templating SQL queries..."
echo_info "Generated 152 unique SQL templates."
echo_step "Analyzing query parameter distributions..."
echo_info "Modeled distributions for timestamp, tenant_id, src_ip."
echo_warn "Parameter 'user_agent' has high cardinality, using random sampling."
echo_step "Transforming schema for ClickHouse..."
echo_info "Mapping type 'BITMAP' to 'AggregateFunction(groupBitmap, UInt64)'."
echo_step "Translating SQL templates to ClickHouse dialect..."
echo_info "Applied 12 dialect-specific rewrite rules."

# Phase 3: Workload Generation
echo_step "Connecting to target database at clickhouse-host:9000..."
echo_info "Connection successful."
echo_step "Preparing benchmark workload..."
echo_info "Concurrency: 64 workers, Duration: 5m0s, QPS Scale: 1.5x"

# Phase 4: Execution
echo_step "Starting benchmark..."
sleep 0.8
# Simple progress bar
for i in {1..20}; do
    echo -ne "[${CYAN}RUNNING${NC}] ${YELLOW}[$(for j in $(seq 1 $i); do echo -n '#'; done)$(for j in $(seq $(($i+1)) 20); do echo -n ' '; done)]${NC} ($((i*5))%) - QPS: 2512.5, Avg Latency: 25.4ms, P95: 68.1ms\r"
    sleep 0.15
done
echo ""
echo_step "Benchmark finished."

# Phase 5: Reporting
echo_step "Generating validation report..."
echo_info "Comparing generated workload metrics against source trace."
sleep 1

# Final Report Output
echo ""
echo "+---------------------------------+"
echo "|      BENCHMARK SUMMARY          |"
echo "+----------------+----------------+"
echo "| Metric         | Value          |"
echo "+----------------+----------------+"
echo "| Total Queries  | 753,750        |"
echo "| Avg QPS        | 2512.5         |"
echo "| Avg Latency    | 24.8ms         |"
echo "| P95 Latency    | 65.2ms         |"
echo "| P99 Latency    | 152.9ms        |"
echo "+----------------+----------------+"
echo ""
echo "+---------------------------------+"
echo "|      DEVIATION ANALYSIS         |"
echo "+----------------+----------------+"
echo "| Metric         | Deviation      |"
echo "+----------------+----------------+"
echo -e "| QPS Distribution | ${GREEN}-2.5%${NC}           |"
echo -e "| Avg Latency      | ${YELLOW}+8.1%${NC}           |"
echo -e "| Hotspot Coverage | ${GREEN}-1.8%${NC}           |"
echo "+----------------+----------------+"
echo ""
echo_step "Report saved to ./reports/report-20250816-1630.md"